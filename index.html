<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Killer Pendiente</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Rajdhani:wght@300;400;500;600;700&family=Orbitron:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --void: #0a0a0f; --space: #0d1117; --nebula: #161b22; --stellar: #21262d;
            --cyan: #00ffff; --cyan-glow: #00e5ff; --cyan-deep: #0097a7;
            --cyan-shadow: rgba(0,255,255,0.1); --cyan-pulse: rgba(0,255,255,0.3);
            --red: #ff3d3d; --orange: #ffaa00; --green: #00ff88;
            --text: #e6edf3; --text-sec: #8b949e; --text-muted: #484f58;
            --glass: rgba(13,17,23,0.9); --glass-border: rgba(0,255,255,0.15);
            --radius: 12px; --radius-lg: 20px;
            --safe-bottom: env(safe-area-inset-bottom, 0px);
        }
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
        html { font-size: 16px; height: 100%; }
        body { font-family: 'Rajdhani', sans-serif; background: var(--void); color: var(--text); min-height: 100%; overflow-x: hidden; -webkit-tap-highlight-color: transparent; }
        
        .cosmic-bg { position: fixed; inset: 0; z-index: -1; background: radial-gradient(ellipse at 20% 20%, rgba(0,255,255,0.08) 0%, transparent 50%), radial-gradient(ellipse at 80% 80%, rgba(0,150,255,0.06) 0%, transparent 50%), linear-gradient(180deg, var(--void) 0%, var(--space) 50%, var(--void) 100%); }
        .stars { position: absolute; inset: 0; background-image: radial-gradient(2px 2px at 20px 30px, rgba(255,255,255,0.8), transparent), radial-gradient(2px 2px at 40px 70px, rgba(0,255,255,0.6), transparent), radial-gradient(1px 1px at 90px 40px, rgba(255,255,255,0.5), transparent); background-size: 200px 200px; animation: float 60s linear infinite; }
        @keyframes float { to { transform: translateY(-200px); } }
        
        .header { height: 56px; background: var(--glass); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-bottom: 1px solid var(--glass-border); display: flex; align-items: center; justify-content: space-between; padding: 0 16px; position: sticky; top: 0; z-index: 100; }
        .logo { display: flex; align-items: center; gap: 10px; }
        .logo-icon { width: 32px; height: 32px; background: linear-gradient(135deg, var(--cyan-glow), var(--cyan-deep)); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 16px; }
        .logo-text { font-family: 'Cinzel', serif; font-weight: 700; font-size: 1rem; letter-spacing: 1px; background: linear-gradient(90deg, #fff, var(--cyan)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .header-actions { display: flex; align-items: center; gap: 10px; }
        .btn-export { padding: 6px 12px; background: var(--stellar); border: 1px solid var(--glass-border); border-radius: 6px; color: var(--cyan); font-size: 0.75rem; cursor: pointer; display: flex; align-items: center; gap: 5px; transition: all 0.3s; }
        .btn-export:hover { background: var(--cyan-shadow); border-color: var(--cyan); }
        .user-avatar { width: 34px; height: 34px; border-radius: 50%; border: 2px solid var(--cyan); display: flex; align-items: center; justify-content: center; font-family: 'Cinzel', serif; font-weight: 700; font-size: 13px; background: var(--nebula); cursor: pointer; transition: all 0.3s; }
        .user-avatar:hover { transform: scale(1.1); }
        
        .screen { display: none; flex: 1; padding: 16px; padding-bottom: calc(70px + var(--safe-bottom)); animation: fadeIn 0.4s ease-out; overflow-y: auto; }
        .screen.active { display: flex; flex-direction: column; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        .login-screen { justify-content: center; align-items: center; min-height: calc(100vh - 56px); padding: 20px; }
        .login-box { width: 100%; max-width: 400px; padding: 24px 20px; background: var(--glass); backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px); border: 1px solid var(--glass-border); border-radius: var(--radius-lg); position: relative; }
        .login-box::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 1px; background: linear-gradient(90deg, transparent, var(--cyan), transparent); }
        .login-title { font-family: 'Cinzel', serif; font-size: 1.5rem; text-align: center; margin-bottom: 4px; background: linear-gradient(135deg, #fff, var(--cyan)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .login-sub { text-align: center; color: var(--text-sec); font-size: 0.8rem; margin-bottom: 16px; }
        
        /* Cargar Huevo - Compacto */
        .load-egg { padding: 16px; background: linear-gradient(135deg, rgba(0,255,255,0.05), rgba(0,150,255,0.05)); border: 2px dashed var(--cyan); border-radius: var(--radius); text-align: center; cursor: pointer; transition: all 0.3s; margin-bottom: 16px; }
        .load-egg:hover, .load-egg:active { background: linear-gradient(135deg, rgba(0,255,255,0.1), rgba(0,150,255,0.1)); border-style: solid; }
        .load-egg-content { display: flex; align-items: center; justify-content: center; gap: 12px; }
        .load-egg-icon { font-size: 28px; }
        .load-egg-text { font-family: 'Cinzel', serif; font-size: 0.85rem; color: var(--cyan); letter-spacing: 1px; }
        
        /* Huevo Cargado - Mini inline */
        .egg-loaded-bar { 
            display: flex; 
            align-items: center; 
            justify-content: space-between;
            padding: 10px 14px; 
            background: linear-gradient(135deg, rgba(109,40,217,0.15), rgba(167,139,250,0.1)); 
            border: 1px solid rgba(167,139,250,0.3); 
            border-radius: var(--radius); 
            margin-bottom: 12px;
        }
        .egg-loaded-left { display: flex; align-items: center; gap: 10px; }
        .mini-egg { 
            width: 24px; height: 30px;
            background: radial-gradient(ellipse at 30% 30%, #a78bfa, #6d28d9 40%, #4c1d95 70%, #1e1b4b);
            border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
            position: relative;
            animation: miniEggPulse 3s ease-in-out infinite;
            box-shadow: 0 0 10px rgba(167, 139, 250, 0.4);
        }
        .mini-egg::before { content: ''; position: absolute; top: 15%; left: 20%; width: 20%; height: 15%; background: radial-gradient(ellipse, rgba(255,255,255,0.7), transparent); border-radius: 50%; }
        @keyframes miniEggPulse { 0%, 100% { box-shadow: 0 0 10px rgba(167, 139, 250, 0.4); } 50% { box-shadow: 0 0 15px rgba(167, 139, 250, 0.6); } }
        .egg-loaded-info { font-size: 0.75rem; color: var(--text-sec); }
        .egg-loaded-info strong { color: var(--cyan); font-family: 'Orbitron', sans-serif; }
        .btn-new-egg { padding: 5px 10px; background: transparent; border: 1px solid var(--glass-border); border-radius: 6px; color: var(--text-muted); font-size: 0.7rem; cursor: pointer; transition: all 0.3s; }
        .btn-new-egg:hover { border-color: var(--red); color: var(--red); }
        
        .divider { display: flex; align-items: center; margin: 10px 0; color: var(--text-muted); font-size: 0.7rem; }
        .divider::before, .divider::after { content: ''; flex: 1; height: 1px; background: var(--glass-border); }
        .divider span { padding: 0 10px; }
        
        /* User cards - M√°s compacto */
        .user-cards { display: grid; grid-template-columns: repeat(auto-fill, minmax(70px, 1fr)); gap: 6px; max-height: 280px; overflow-y: auto; padding: 4px; margin-bottom: 12px; }
        .user-card { padding: 8px 4px; background: var(--stellar); border: 1px solid transparent; border-radius: 10px; cursor: pointer; text-align: center; transition: all 0.3s; }
        .user-card:hover, .user-card:active { border-color: var(--cyan); }
        .user-card.selected { border-color: var(--cyan); background: linear-gradient(135deg, var(--cyan-shadow), transparent); box-shadow: 0 0 15px var(--cyan-shadow); }
        .user-card-initial { width: 30px; height: 30px; margin: 0 auto 3px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-family: 'Cinzel', serif; font-weight: 700; font-size: 12px; color: var(--void); }
        .user-card-name { font-weight: 600; font-size: 0.7rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .user-card-xp { font-family: 'Orbitron', sans-serif; font-size: 0.55rem; color: var(--cyan); margin-top: 1px; }
        .no-users { text-align: center; padding: 20px; color: var(--text-muted); font-size: 0.8rem; }
        
        .input-group { margin-bottom: 12px; }
        .input-label { display: block; font-family: 'Orbitron', sans-serif; font-size: 0.6rem; color: var(--cyan); letter-spacing: 2px; margin-bottom: 5px; }
        .input-field { width: 100%; padding: 10px 12px; background: var(--stellar); border: 1px solid var(--glass-border); border-radius: var(--radius); color: var(--text); font-family: 'Rajdhani', sans-serif; font-size: 0.95rem; outline: none; transition: all 0.3s; -webkit-appearance: none; }
        .input-field:focus { border-color: var(--cyan); box-shadow: 0 0 12px var(--cyan-shadow); }
        .btn-primary { width: 100%; padding: 12px 18px; background: linear-gradient(135deg, var(--cyan-glow), var(--cyan-deep)); border: none; border-radius: var(--radius); color: var(--void); font-family: 'Cinzel', serif; font-weight: 700; font-size: 0.9rem; letter-spacing: 2px; cursor: pointer; transition: all 0.3s; }
        .btn-primary:hover, .btn-primary:active { box-shadow: 0 6px 25px var(--cyan-pulse); }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }
        
        /* Tabs para login */
        .login-tabs { display: flex; margin-bottom: 16px; border-radius: 8px; overflow: hidden; border: 1px solid var(--glass-border); }
        .login-tab { flex: 1; padding: 10px; background: var(--stellar); border: none; color: var(--text-sec); font-size: 0.8rem; cursor: pointer; transition: all 0.3s; }
        .login-tab.active { background: var(--cyan-shadow); color: var(--cyan); }
        .login-tab:first-child { border-right: 1px solid var(--glass-border); }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* Main Screen */
        .main-screen { gap: 14px; }
        
        .stats-panel { background: var(--glass); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid var(--glass-border); border-radius: var(--radius-lg); padding: 14px; position: relative; }
        .stats-panel::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px; background: linear-gradient(90deg, var(--cyan-deep), var(--cyan), var(--cyan-deep)); }
        .stats-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }
        .stats-info { display: flex; align-items: center; gap: 10px; }
        .stats-avatar { width: 40px; height: 40px; border-radius: 50%; border: 2px solid; display: flex; align-items: center; justify-content: center; font-family: 'Cinzel', serif; font-weight: 700; font-size: 16px; cursor: pointer; flex-shrink: 0; }
        .stats-name { font-family: 'Cinzel', serif; font-weight: 600; font-size: 1rem; }
        .stats-level { font-family: 'Orbitron', sans-serif; font-size: 0.65rem; color: var(--cyan); letter-spacing: 1px; }
        .btn-logout { padding: 5px 10px; background: var(--stellar); border: 1px solid var(--glass-border); border-radius: 6px; color: var(--text-sec); font-size: 0.7rem; cursor: pointer; }
        .btn-logout:hover { border-color: var(--cyan); color: var(--cyan); }
        
        .xp-container { margin-bottom: 10px; }
        .xp-labels { display: flex; justify-content: space-between; font-size: 0.65rem; color: var(--text-sec); margin-bottom: 4px; }
        .xp-bar { height: 5px; background: var(--stellar); border-radius: 3px; overflow: hidden; }
        .xp-fill { height: 100%; background: linear-gradient(90deg, var(--cyan-deep), var(--cyan)); border-radius: 3px; transition: width 0.5s; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; }
        .stat-item { text-align: center; padding: 8px 4px; background: var(--stellar); border-radius: 8px; }
        .stat-value { font-family: 'Orbitron', sans-serif; font-size: 1.1rem; font-weight: 700; color: var(--cyan); }
        .stat-label { font-size: 0.55rem; color: var(--text-sec); text-transform: uppercase; letter-spacing: 0.5px; margin-top: 2px; }
        
        .add-section { background: var(--glass); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid var(--glass-border); border-radius: var(--radius-lg); padding: 14px; }
        .section-title { font-family: 'Cinzel', serif; font-size: 0.9rem; margin-bottom: 10px; display: flex; align-items: center; gap: 6px; }
        .task-row { display: flex; gap: 8px; margin-bottom: 10px; }
        .task-input { flex: 1; padding: 10px 12px; background: var(--stellar); border: 1px solid var(--glass-border); border-radius: var(--radius); color: var(--text); font-family: 'Rajdhani', sans-serif; font-size: 0.9rem; outline: none; }
        .task-input:focus { border-color: var(--cyan); }
        .task-options { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; }
        .task-opt-label { font-size: 0.55rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 3px; }
        .task-select, .task-num { padding: 8px 6px; background: var(--stellar); border: 1px solid var(--glass-border); border-radius: 6px; color: var(--text); font-size: 0.8rem; outline: none; width: 100%; -webkit-appearance: none; }
        .task-select option { background: var(--nebula); }
        .btn-add { width: 100%; margin-top: 10px; padding: 10px; background: linear-gradient(135deg, var(--cyan-glow), var(--cyan-deep)); border: none; border-radius: var(--radius); color: var(--void); font-weight: 700; font-size: 0.85rem; letter-spacing: 1px; cursor: pointer; }
        
        .filters-bar { display: flex; gap: 6px; margin-bottom: 10px; flex-wrap: wrap; }
        .filter-select-small { padding: 5px 8px; background: var(--stellar); border: 1px solid var(--glass-border); border-radius: 15px; font-size: 0.7rem; color: var(--text); cursor: pointer; -webkit-appearance: none; }
        .filter-select-small:focus { border-color: var(--cyan); outline: none; }
        
        .tasks-section { flex: 1; }
        .tasks-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .tasks-title { font-family: 'Cinzel', serif; font-size: 0.95rem; display: flex; align-items: center; gap: 6px; }
        .tasks-count { background: var(--cyan-shadow); color: var(--cyan); padding: 2px 8px; border-radius: 12px; font-family: 'Orbitron', sans-serif; font-size: 0.65rem; }
        .tasks-list { display: flex; flex-direction: column; gap: 6px; }
        
        .task-card { background: var(--glass); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border: 1px solid var(--glass-border); border-radius: 10px; padding: 10px; display: flex; align-items: center; gap: 8px; transition: all 0.3s; position: relative; }
        .task-card::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 3px; border-radius: 3px 0 0 3px; }
        .task-card.priority-a::before { background: var(--red); }
        .task-card.priority-b::before { background: var(--orange); }
        .task-card.priority-c::before { background: var(--green); }
        .task-card:active { transform: scale(0.98); }
        .task-card.completed { opacity: 0.5; }
        .task-card.completed .task-name { text-decoration: line-through; color: var(--text-muted); }
        
        .task-actions { display: flex; gap: 5px; flex-shrink: 0; }
        .task-play { width: 28px; height: 28px; border-radius: 50%; background: linear-gradient(135deg, var(--green), #00cc6a); border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 10px; }
        .task-play:active { transform: scale(0.9); }
        .task-check { width: 24px; height: 24px; border: 2px solid var(--text-muted); border-radius: 5px; display: flex; align-items: center; justify-content: center; cursor: pointer; background: transparent; }
        .task-check.checked { background: var(--cyan); border-color: var(--cyan); }
        .task-check.checked::after { content: '‚úì'; color: var(--void); font-weight: 700; font-size: 11px; }
        
        .task-content { flex: 1; min-width: 0; }
        .task-name { font-weight: 600; font-size: 0.85rem; margin-bottom: 1px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .task-meta { display: flex; gap: 6px; font-size: 0.6rem; color: var(--text-sec); flex-wrap: wrap; }
        .task-age { color: var(--orange); }
        .task-xp { font-family: 'Orbitron', sans-serif; font-weight: 700; color: var(--cyan); font-size: 0.75rem; flex-shrink: 0; }
        .task-owner { font-size: 0.6rem; padding: 1px 5px; background: var(--stellar); border-radius: 3px; }
        .tasks-empty { text-align: center; padding: 30px 15px; color: var(--text-muted); }
        .tasks-empty-icon { font-size: 32px; margin-bottom: 8px; opacity: 0.5; }
        
        /* Timer */
        .timer-popup { position: fixed; bottom: calc(65px + var(--safe-bottom)); right: 10px; left: 10px; max-width: 280px; margin-left: auto; background: var(--nebula); border: 1px solid var(--glass-border); border-radius: var(--radius-lg); box-shadow: 0 8px 40px rgba(0,0,0,0.6); z-index: 500; overflow: hidden; display: none; animation: timerSlideIn 0.4s ease-out; }
        .timer-popup.show { display: block; }
        @keyframes timerSlideIn { from { transform: translateY(100px) scale(0.8); opacity: 0; } to { transform: translateY(0) scale(1); opacity: 1; } }
        .timer-header { padding: 8px 10px; background: var(--stellar); display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid var(--glass-border); }
        .timer-task-name { font-weight: 600; font-size: 0.75rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex: 1; margin-right: 6px; }
        .timer-close { width: 26px; height: 26px; background: transparent; border: none; color: var(--text-sec); cursor: pointer; border-radius: 5px; display: flex; align-items: center; justify-content: center; font-size: 14px; }
        .timer-close:active { background: rgba(255,61,61,0.2); color: var(--red); }
        .timer-body { padding: 14px; text-align: center; }
        .timer-display { font-family: 'Orbitron', sans-serif; font-size: 2.2rem; font-weight: 700; margin-bottom: 6px; }
        .timer-display.green { color: var(--green); text-shadow: 0 0 12px rgba(0,255,136,0.5); }
        .timer-display.orange { color: var(--orange); text-shadow: 0 0 12px rgba(255,170,0,0.5); }
        .timer-display.red { color: var(--red); text-shadow: 0 0 12px rgba(255,61,61,0.5); animation: timerPulse 0.5s ease-in-out infinite; }
        @keyframes timerPulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.02); } }
        .timer-progress { height: 4px; background: var(--stellar); border-radius: 2px; overflow: hidden; margin-bottom: 10px; }
        .timer-progress-fill { height: 100%; border-radius: 2px; transition: width 1s linear, background 0.5s ease; }
        .timer-progress-fill.green { background: var(--green); }
        .timer-progress-fill.orange { background: var(--orange); }
        .timer-progress-fill.red { background: var(--red); }
        .timer-actions { display: flex; gap: 6px; justify-content: center; }
        .timer-btn { padding: 8px 14px; border: none; border-radius: 6px; font-weight: 600; font-size: 0.8rem; cursor: pointer; }
        .timer-btn-done { background: var(--green); color: var(--void); }
        .timer-btn-distraction { background: var(--stellar); color: var(--text); border: 1px solid var(--glass-border); }
        
        /* Modales */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; visibility: hidden; transition: all 0.3s; padding: 16px; }
        .modal-overlay.show { opacity: 1; visibility: visible; }
        .modal { background: var(--nebula); border: 1px solid var(--glass-border); border-radius: var(--radius-lg); width: 100%; max-width: 380px; max-height: 90vh; overflow-y: auto; transform: scale(0.9); transition: transform 0.3s; }
        .modal-overlay.show .modal { transform: scale(1); }
        .modal-header { padding: 14px; border-bottom: 1px solid var(--glass-border); display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; background: var(--nebula); z-index: 1; }
        .modal-title { font-family: 'Cinzel', serif; font-size: 1rem; }
        .modal-close { width: 30px; height: 30px; background: var(--stellar); border: none; border-radius: 6px; color: var(--text-sec); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 16px; }
        .modal-close:active { color: var(--red); }
        .modal-body { padding: 14px; }
        .modal-footer { padding: 14px; border-top: 1px solid var(--glass-border); display: flex; gap: 8px; justify-content: flex-end; }
        .btn-secondary { padding: 10px 18px; background: var(--stellar); border: 1px solid var(--glass-border); border-radius: 6px; color: var(--text); cursor: pointer; font-size: 0.85rem; }
        
        .complete-modal .modal { max-width: 320px; }
        .complete-content { text-align: center; padding: 8px; }
        .complete-icon { font-size: 36px; margin-bottom: 10px; }
        .complete-title { font-family: 'Cinzel', serif; font-size: 1.1rem; margin-bottom: 6px; }
        .complete-text { color: var(--text-sec); margin-bottom: 14px; font-size: 0.85rem; }
        .complete-actions { display: flex; flex-direction: column; gap: 6px; }
        .complete-btn { padding: 10px 18px; border: none; border-radius: 6px; font-weight: 600; font-size: 0.9rem; cursor: pointer; }
        .complete-yes { background: var(--green); color: var(--void); }
        .complete-no { background: var(--stellar); color: var(--text); }
        .extra-time-input { display: none; margin-top: 10px; }
        .extra-time-input.show { display: block; }
        .extra-time-input input { width: 100%; padding: 10px; background: var(--stellar); border: 1px solid var(--glass-border); border-radius: 6px; color: var(--text); font-size: 1rem; text-align: center; margin-bottom: 6px; }
        
        .universe-header { background: var(--glass); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid var(--glass-border); border-radius: var(--radius-lg); padding: 14px; margin-bottom: 14px; }
        .universe-title { font-family: 'Cinzel', serif; font-size: 1.1rem; text-align: center; margin-bottom: 10px; background: linear-gradient(90deg, #fff, var(--cyan)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .filters { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; }
        .filter-group { }
        .filter-label { font-size: 0.55rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 3px; display: block; }
        .filter-select { width: 100%; padding: 7px; background: var(--stellar); border: 1px solid var(--glass-border); border-radius: 5px; color: var(--text); font-size: 0.75rem; }
        .universe-stats { display: flex; justify-content: center; gap: 20px; margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--glass-border); }
        .uni-stat { text-align: center; }
        .uni-stat-value { font-family: 'Orbitron', sans-serif; font-size: 1.2rem; color: var(--cyan); }
        .uni-stat-label { font-size: 0.6rem; color: var(--text-muted); text-transform: uppercase; }
        
        .idea-cards { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; }
        .idea-card { background: var(--stellar); border: 1px solid var(--glass-border); border-radius: 10px; padding: 12px; position: relative; }
        .idea-card:active { transform: scale(0.98); }
        .idea-text { font-size: 0.85rem; line-height: 1.3; }
        .idea-actions { position: absolute; top: 6px; right: 6px; display: flex; gap: 3px; }
        .idea-btn { width: 24px; height: 24px; background: var(--nebula); border: none; border-radius: 5px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 10px; }
        
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; height: calc(52px + var(--safe-bottom)); padding-bottom: var(--safe-bottom); background: var(--glass); backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px); border-top: 1px solid var(--glass-border); display: flex; justify-content: space-around; align-items: center; z-index: 100; }
        .nav-item { display: flex; flex-direction: column; align-items: center; gap: 2px; padding: 6px 14px; border-radius: 8px; cursor: pointer; color: var(--text-muted); transition: all 0.3s; }
        .nav-item:active, .nav-item.active { color: var(--cyan); background: var(--cyan-shadow); }
        .nav-icon { font-size: 16px; }
        .nav-label { font-size: 0.5rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        
        .context-menu { position: fixed; background: var(--nebula); border: 1px solid var(--glass-border); border-radius: 10px; padding: 5px 0; min-width: 150px; box-shadow: 0 8px 30px rgba(0,0,0,0.5); z-index: 1000; display: none; }
        .context-menu.show { display: block; }
        .ctx-item { padding: 9px 14px; cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 0.85rem; }
        .ctx-item:active { background: var(--stellar); color: var(--cyan); }
        .ctx-item.danger { color: var(--red); }
        .ctx-divider { height: 1px; background: var(--glass-border); margin: 4px 0; }
        
        .toast { position: fixed; bottom: calc(65px + var(--safe-bottom)); left: 50%; transform: translateX(-50%) translateY(100px); background: var(--stellar); border: 1px solid var(--cyan); padding: 8px 16px; border-radius: 10px; box-shadow: 0 8px 30px var(--cyan-shadow); z-index: 2000; opacity: 0; transition: all 0.4s; font-size: 0.85rem; text-align: center; max-width: 90%; }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        .toast.success { border-color: var(--green); }
        .toast.error { border-color: var(--red); }
        
        ::-webkit-scrollbar { width: 3px; height: 3px; }
        ::-webkit-scrollbar-track { background: var(--stellar); }
        ::-webkit-scrollbar-thumb { background: var(--cyan-deep); border-radius: 2px; }
        
        @media (min-width: 768px) {
            .login-box { padding: 30px 28px; }
            .timer-popup { left: auto; right: 16px; bottom: 70px; }
        }
        @media (max-width: 360px) {
            .task-options { grid-template-columns: repeat(2, 1fr); }
            .filters { grid-template-columns: 1fr 1fr; }
            .filter-group:last-child { grid-column: span 2; }
        }
    </style>
</head>
<body>
    <div class="cosmic-bg"><div class="stars"></div></div>
    
    <div class="app">
        <header class="header">
            <div class="logo"><div class="logo-icon">ü•ö</div><span class="logo-text">KILLER PENDIENTE</span></div>
            <div class="header-actions">
                <button class="btn-export" id="btnExport" style="display:none" onclick="exportEgg()">üíæ</button>
                <div class="user-avatar" id="headerAvatar" style="display:none" onclick="logout()">A</div>
            </div>
        </header>

        <!-- LOGIN -->
        <div class="screen login-screen active" id="loginScreen">
            <div class="login-box">
                <h1 class="login-title">KILLER PENDIENTE</h1>
                <p class="login-sub" id="loginSub">Inicia sesi√≥n o carga tu Huevo C√≥smico</p>
                
                <!-- Tabs -->
                <div class="login-tabs">
                    <button class="login-tab active" onclick="switchLoginTab('egg')">ü•ö Huevo</button>
                    <button class="login-tab" onclick="switchLoginTab('user')">üë§ Usuario</button>
                </div>
                
                <!-- Tab Huevo C√≥smico -->
                <div class="tab-content active" id="tabEgg">
                    <!-- Cargar Huevo (antes de cargar) -->
                    <div class="load-egg" id="loadEggBtn" onclick="document.getElementById('fileInput').click()">
                        <div class="load-egg-content">
                            <span class="load-egg-icon">ü•ö</span>
                            <div>
                                <div class="load-egg-text">Cargar Huevo C√≥smico</div>
                                <div class="load-egg-hint" style="font-size:0.65rem;color:var(--text-muted)">.cegg o .json</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Huevo cargado (mini bar) -->
                    <div class="egg-loaded-bar" id="eggLoadedBar" style="display:none">
                        <div class="egg-loaded-left">
                            <div class="mini-egg"></div>
                            <div class="egg-loaded-info"><strong id="eggUserCount">0</strong> aspectos cargados</div>
                        </div>
                        <button class="btn-new-egg" onclick="resetEgg()">Cambiar</button>
                    </div>
                    
                    <input type="file" id="fileInput" style="display:none" accept=".cegg,.json" onchange="loadEgg(event)">
                    
                    <div class="divider"><span>selecciona un aspecto</span></div>
                    
                    <div class="user-cards" id="userCards">
                        <div class="no-users">üåå Carga un Huevo C√≥smico</div>
                    </div>
                </div>
                
                <!-- Tab Usuario/Contrase√±a -->
                <div class="tab-content" id="tabUser">
                    <div class="input-group">
                        <label class="input-label">Usuario</label>
                        <input type="text" class="input-field" id="loginUser" placeholder="Tu nombre de usuario">
                    </div>
                    <div class="input-group">
                        <label class="input-label">Contrase√±a</label>
                        <input type="password" class="input-field" id="loginPass" placeholder="Tu contrase√±a">
                    </div>
                    <p style="font-size:0.7rem;color:var(--text-muted);text-align:center;margin-bottom:12px">
                        Crea un usuario nuevo o inicia sesi√≥n
                    </p>
                </div>
                
                <!-- Contrase√±a para aspecto seleccionado -->
                <div class="input-group" id="passGroup" style="display:none">
                    <label class="input-label">Contrase√±a del Aspecto</label>
                    <input type="password" class="input-field" id="passInput" placeholder="Contrase√±a">
                </div>
                
                <button class="btn-primary" id="loginBtn" onclick="handleLogin()">ENTRAR</button>
            </div>
        </div>

        <!-- MAIN -->
        <div class="screen main-screen" id="mainScreen">
            <div class="stats-panel">
                <div class="stats-header">
                    <div class="stats-info">
                        <div class="stats-avatar" id="sAvatar">D</div>
                        <div><div class="stats-name" id="sName">Demo</div><div class="stats-level">NIVEL <span id="sLevel">1</span></div></div>
                    </div>
                    <button class="btn-logout" onclick="logout()">Salir</button>
                </div>
                <div class="xp-container">
                    <div class="xp-labels"><span>Pv: <span id="curXp">0</span>/<span id="nextXp">100</span></span><span id="xpPct">0%</span></div>
                    <div class="xp-bar"><div class="xp-fill" id="xpFill"></div></div>
                </div>
                <div class="stats-grid">
                    <div class="stat-item"><div class="stat-value" id="totalXp">0</div><div class="stat-label">Pv Total</div></div>
                    <div class="stat-item"><div class="stat-value" id="coins">0</div><div class="stat-label">Mu</div></div>
                    <div class="stat-item"><div class="stat-value" id="pending">0</div><div class="stat-label">Pendientes</div></div>
                </div>
            </div>
            
            <div class="add-section">
                <h3 class="section-title">‚öîÔ∏è Nuevo Desaf√≠o</h3>
                <div class="task-row"><input type="text" class="task-input" id="taskName" placeholder="Describe tu desaf√≠o..."></div>
                <div class="task-options">
                    <div><div class="task-opt-label">Pv</div><input type="number" class="task-num" id="taskXp" value="10" min="1"></div>
                    <div><div class="task-opt-label">Min</div><input type="number" class="task-num" id="taskTime" value="30" min="1"></div>
                    <div><div class="task-opt-label">Prior.</div><select class="task-select" id="taskPri"><option value="C">C</option><option value="B">B</option><option value="A">A</option></select></div>
                    <div><div class="task-opt-label">Cat.</div><select class="task-select" id="taskCat"><option>Otro</option><option>Pega</option><option>Proyectos</option><option>Casa</option><option>Jard√≠n</option><option>Deporte</option></select></div>
                </div>
                <button class="btn-add" onclick="addTask()">‚ö° A√±adir</button>
            </div>
            
            <div class="tasks-section">
                <div class="tasks-header"><h3 class="tasks-title">üéØ Desaf√≠os <span class="tasks-count" id="tCount">0</span></h3></div>
                <div class="filters-bar">
                    <select class="filter-select-small" id="sortBy" onchange="loadTasks()"><option value="priority">Prioridad</option><option value="date-asc">Antiguos</option><option value="date-desc">Recientes</option></select>
                    <select class="filter-select-small" id="filterPri" onchange="loadTasks()"><option value="all">Todas</option><option value="A">A</option><option value="B">B</option><option value="C">C</option></select>
                </div>
                <div class="tasks-list" id="tasksList"></div>
            </div>
        </div>

        <!-- UNIVERSE -->
        <div class="screen" id="universeScreen">
            <div class="universe-header">
                <h2 class="universe-title">üåå UNIVERSO</h2>
                <div class="filters">
                    <div class="filter-group"><label class="filter-label">Usuario</label><select class="filter-select" id="fUser" onchange="filterUniverse()"><option value="all">Todos</option></select></div>
                    <div class="filter-group"><label class="filter-label">Prior.</label><select class="filter-select" id="fPri" onchange="filterUniverse()"><option value="all">Todas</option><option value="A">A</option><option value="B">B</option><option value="C">C</option></select></div>
                    <div class="filter-group"><label class="filter-label">Orden</label><select class="filter-select" id="fSort" onchange="filterUniverse()"><option value="priority">Prior.</option><option value="date-asc">Antiguos</option><option value="date-desc">Recientes</option></select></div>
                </div>
                <div class="universe-stats">
                    <div class="uni-stat"><div class="uni-stat-value" id="uniTotal">0</div><div class="uni-stat-label">Tareas</div></div>
                    <div class="uni-stat"><div class="uni-stat-value" id="uniXp">0</div><div class="uni-stat-label">Pv</div></div>
                </div>
            </div>
            <div class="tasks-list" id="uniList"></div>
        </div>

        <!-- BRAINSTORM -->
        <div class="screen" id="brainstormScreen">
            <div class="add-section">
                <h3 class="section-title">üí° Nueva Idea</h3>
                <div class="task-row"><input type="text" class="task-input" id="ideaInput" placeholder="Captura tu idea..."></div>
                <button class="btn-add" onclick="addIdea()">üí° Guardar</button>
            </div>
            <div class="tasks-section">
                <div class="tasks-header"><h3 class="tasks-title">üß† Ideas <span class="tasks-count" id="iCount">0</span></h3></div>
                <div class="idea-cards" id="ideasList"></div>
            </div>
        </div>

        <nav class="bottom-nav" id="nav" style="display:none">
            <a class="nav-item active" onclick="showScreen('main')" data-s="main"><span class="nav-icon">üéØ</span><span class="nav-label">Tareas</span></a>
            <a class="nav-item" onclick="showScreen('universe')" data-s="universe"><span class="nav-icon">üåå</span><span class="nav-label">Universo</span></a>
            <a class="nav-item" onclick="showScreen('brainstorm')" data-s="brainstorm"><span class="nav-icon">üí°</span><span class="nav-label">Ideas</span></a>
        </nav>
    </div>

    <!-- TIMER -->
    <div class="timer-popup" id="timerPopup">
        <div class="timer-header"><div class="timer-task-name" id="timerTaskName">Tarea</div><button class="timer-close" onclick="cancelTimer()">‚úï</button></div>
        <div class="timer-body">
            <div class="timer-display green" id="timerDisplay">00:00</div>
            <div class="timer-progress"><div class="timer-progress-fill green" id="timerProgress" style="width:100%"></div></div>
            <div class="timer-actions"><button class="timer-btn timer-btn-done" onclick="timerDone()">‚úì Listo</button><button class="timer-btn timer-btn-distraction" onclick="logDistraction()">üìù</button></div>
        </div>
    </div>

    <!-- COMPLETE MODAL -->
    <div class="modal-overlay complete-modal" id="completeModal">
        <div class="modal">
            <div class="complete-content">
                <div class="complete-icon">‚è∞</div>
                <div class="complete-title" id="completeTitle">¬°Tiempo!</div>
                <div class="complete-text">¬øCompletaste la tarea?</div>
                <div class="complete-actions" id="completeActions">
                    <button class="complete-btn complete-yes" onclick="confirmComplete(true)">‚úì ¬°S√≠!</button>
                    <button class="complete-btn complete-no" onclick="confirmComplete(false)">M√°s tiempo</button>
                </div>
                <div class="extra-time-input" id="extraTimeInput">
                    <input type="number" id="extraTimeValue" placeholder="Minutos" min="1" value="15">
                    <button class="complete-btn complete-yes" onclick="addExtraTime()">Agregar</button>
                    <button class="complete-btn complete-no" onclick="closeCompleteModal()">Cancelar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- EDIT MODAL -->
    <div class="modal-overlay" id="editModal">
        <div class="modal">
            <div class="modal-header"><h3 class="modal-title">Editar</h3><button class="modal-close" onclick="closeEditModal()">‚úï</button></div>
            <div class="modal-body">
                <div class="input-group"><label class="input-label">Nombre</label><input type="text" class="input-field" id="eName"></div>
                <div class="task-options" style="margin-top:10px">
                    <div><div class="task-opt-label">Pv</div><input type="number" class="task-num" id="eXp"></div>
                    <div><div class="task-opt-label">Min</div><input type="number" class="task-num" id="eTime"></div>
                    <div><div class="task-opt-label">Prior.</div><select class="task-select" id="ePri"><option value="C">C</option><option value="B">B</option><option value="A">A</option></select></div>
                    <div><div class="task-opt-label">Cat.</div><select class="task-select" id="eCat"><option>Otro</option><option>Pega</option><option>Proyectos</option><option>Casa</option><option>Jard√≠n</option><option>Deporte</option></select></div>
                </div>
            </div>
            <div class="modal-footer"><button class="btn-secondary" onclick="closeEditModal()">Cancelar</button><button class="btn-primary" style="width:auto" onclick="saveEdit()">Guardar</button></div>
        </div>
    </div>

    <!-- DISTRACTION MODAL -->
    <div class="modal-overlay" id="distractionModal">
        <div class="modal">
            <div class="modal-header"><h3 class="modal-title">üìù Distracci√≥n</h3><button class="modal-close" onclick="closeDistractionModal()">‚úï</button></div>
            <div class="modal-body"><div class="input-group"><label class="input-label">¬øQu√© te distrajo?</label><textarea class="input-field" id="distractionText" rows="3" placeholder="Describe..."></textarea></div></div>
            <div class="modal-footer"><button class="btn-secondary" onclick="closeDistractionModal()">Cancelar</button><button class="btn-primary" style="width:auto" onclick="saveDistraction()">Guardar</button></div>
        </div>
    </div>

    <div class="context-menu" id="ctxMenu">
        <div class="ctx-item" onclick="ctxPlay()">‚ñ∂Ô∏è Timer</div>
        <div class="ctx-item" onclick="ctxComplete()">‚úì Completar</div>
        <div class="ctx-item" onclick="ctxEdit()">‚úèÔ∏è Editar</div>
        <div class="ctx-divider"></div>
        <div class="ctx-item danger" onclick="ctxDelete()">üóëÔ∏è Eliminar</div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
    const S = { user: null, users: {}, tasks: [], xp: {}, coins: {}, ideas: [], selCard: null, selTask: null, loaded: false, originalEgg: null, loginMode: 'egg', localUsers: {} };
    const Timer = { active: false, taskId: null, totalSeconds: 0, remaining: 0, interval: null };
    
    const calcLevel = (xp) => { let l=1,a=0,n=100; while(xp>=a+n){a+=n;l++;n=Math.floor(100*Math.pow(1.5,l-1));} return {lvl:l,cur:xp-a,next:n}; };
    const colors = ['#00ffff','#ff6b6b','#4ecdc4','#45b7d1','#96ceb4','#ffeaa7','#fd79a8','#6c5ce7'];
    const getColor = (n) => colors[Math.abs([...n].reduce((a,c)=>c.charCodeAt(0)+((a<<5)-a),0))%colors.length];
    const uuid = () => 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,c=>{const r=Math.random()*16|0;return(c=='x'?r:(r&0x3|0x8)).toString(16);});
    const fmtDate = (d) => `${d.getDate().toString().padStart(2,'0')}-${(d.getMonth()+1).toString().padStart(2,'0')}-${d.getFullYear()}`;
    const fmtDateTime = (d) => `${fmtDate(d)} ${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}:${d.getSeconds().toString().padStart(2,'0')}`;
    const esc = (t) => { const d=document.createElement('div'); d.textContent=t||''; return d.innerHTML; };
    const toast = (msg, type='info') => { const t=document.getElementById('toast'); t.textContent=msg; t.className='toast '+type+' show'; setTimeout(()=>t.classList.remove('show'),3000); };
    
    function getTimeAgo(dateStr) {
        if(!dateStr) return '';
        try {
            const parts = dateStr.split('-');
            if(parts.length !== 3) return '';
            const d = new Date(parts[2], parts[1]-1, parts[0]);
            const diff = Math.floor((new Date() - d) / (1000*60*60*24));
            if(diff === 0) return 'hoy';
            if(diff === 1) return 'ayer';
            if(diff < 7) return `${diff}d`;
            if(diff < 30) return `${Math.floor(diff/7)}sem`;
            if(diff < 365) return `${Math.floor(diff/30)}m`;
            return `${Math.floor(diff/365)}a`;
        } catch(e) { return ''; }
    }
    
    function parseDate(dateStr) {
        if(!dateStr) return new Date(0);
        try { const p = dateStr.split('-'); return new Date(p[2], p[1]-1, p[0]); } catch(e) { return new Date(0); }
    }
    
    // Login Tabs
    function switchLoginTab(tab) {
        S.loginMode = tab;
        document.querySelectorAll('.login-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        
        if(tab === 'egg') {
            document.querySelector('.login-tab:first-child').classList.add('active');
            document.getElementById('tabEgg').classList.add('active');
            document.getElementById('loginBtn').textContent = S.loaded ? 'ENTRAR' : 'CARGAR HUEVO';
        } else {
            document.querySelector('.login-tab:last-child').classList.add('active');
            document.getElementById('tabUser').classList.add('active');
            document.getElementById('loginBtn').textContent = 'ENTRAR';
        }
        
        document.getElementById('passGroup').style.display = 'none';
        S.selCard = null;
        document.querySelectorAll('.user-card').forEach(c => c.classList.remove('selected'));
    }
    
    function handleLogin() {
        if(S.loginMode === 'user') {
            loginWithUser();
        } else {
            if(S.selCard) {
                login();
            } else if(!S.loaded) {
                document.getElementById('fileInput').click();
            } else {
                toast('Selecciona un aspecto', 'error');
            }
        }
    }
    
    function loginWithUser() {
        const username = document.getElementById('loginUser').value.trim();
        const password = document.getElementById('loginPass').value;
        
        if(!username) { toast('Ingresa usuario', 'error'); return; }
        if(!password) { toast('Ingresa contrase√±a', 'error'); return; }
        
        // Verificar o crear usuario local
        if(!S.localUsers[username]) {
            // Crear nuevo usuario
            S.localUsers[username] = { password, color: getColor(username) };
            S.users[username] = { color: getColor(username) };
            S.xp[username] = 0;
            S.coins[username] = 0;
            save();
            toast('Usuario creado', 'success');
        } else {
            // Verificar contrase√±a
            if(S.localUsers[username].password !== password) {
                toast('Contrase√±a incorrecta', 'error');
                return;
            }
        }
        
        S.user = username;
        if(!S.users[username]) {
            S.users[username] = { color: getColor(username) };
        }
        
        loadUserData();
        document.getElementById('headerAvatar').style.display='flex';
        document.getElementById('btnExport').style.display='flex';
        document.getElementById('nav').style.display='flex';
        showScreen('main');
        toast(`¬°Hola, ${username}!`, 'success');
    }
    
    // Cargar Huevo
    function loadEgg(e) {
        const file = e.target.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = (ev) => {
            try {
                let content = ev.target.result;
                if(content.includes('<<<COSMIC-EGG-START>>>')) {
                    const match = content.match(/<<<DATA-START>>>([\s\S]*?)<<<DATA-END>>>/);
                    if(match) content = match[1].trim();
                }
                const data = JSON.parse(content);
                S.originalEgg = data;
                processEgg(data);
            } catch(err) { toast('Error: '+err.message, 'error'); }
        };
        reader.readAsText(file);
    }
    
    function processEgg(data) {
        const users = data.perfil_global?.lista_usuarios || [];
        const perfiles = data.perfiles_usuarios || {};
        if(!users.length) { toast('Sin usuarios', 'error'); return; }
        
        // Mantener usuarios locales existentes
        users.forEach(u => {
            const p = perfiles[u] || {};
            const q = p.datos_cuantitativos || {};
            const c = p.datos_cualitativos || {};
            const nx = q.nivel_y_xp || {};
            
            S.users[u] = { color: getColor(u) };
            S.xp[u] = nx.xp_total || 0;
            S.coins[u] = nx.mu_disponibles || 0;
            
            (c.tareas_detalladas || []).forEach(t => { t.username=u; if(!t.id) t.id=uuid(); S.tasks.push(t); });
            (c.brainstorming_ideas || []).forEach(i => { if(i && typeof i==='string') S.ideas.push({id:uuid(),name:i}); });
        });
        
        S.loaded = true;
        save();
        
        document.getElementById('loadEggBtn').style.display = 'none';
        document.getElementById('eggLoadedBar').style.display = 'flex';
        document.getElementById('eggUserCount').textContent = users.length;
        document.getElementById('loginBtn').textContent = 'ENTRAR';
        document.getElementById('btnExport').style.display = 'flex';
        
        renderUsers();
        updateFilters();
        toast(`¬°${users.length} usuario(s)!`, 'success');
    }
    
    function resetEgg() {
        if(!confirm('¬øCargar otro huevo?')) return;
        S.loaded = false;
        S.originalEgg = null;
        // Mantener usuarios locales y sus tareas
        const localUsernames = Object.keys(S.localUsers);
        const newUsers = {};
        const newXp = {};
        const newCoins = {};
        const newTasks = S.tasks.filter(t => localUsernames.includes(t.username));
        
        localUsernames.forEach(u => {
            if(S.users[u]) newUsers[u] = S.users[u];
            if(S.xp[u]) newXp[u] = S.xp[u];
            if(S.coins[u]) newCoins[u] = S.coins[u];
        });
        
        S.users = newUsers;
        S.xp = newXp;
        S.coins = newCoins;
        S.tasks = newTasks;
        S.ideas = [];
        
        document.getElementById('loadEggBtn').style.display = 'block';
        document.getElementById('eggLoadedBar').style.display = 'none';
        document.getElementById('loginBtn').textContent = 'CARGAR HUEVO';
        
        renderUsers();
        save();
    }
    
    function exportEgg() {
        const users = Object.keys(S.users);
        if(!users.length) { toast('No hay datos', 'error'); return; }
        
        const perfiles = {};
        users.forEach(u => {
            const userTasks = S.tasks.filter(t => t.username === u);
            const distractions = [];
            const completionHours = {};
            
            userTasks.forEach(t => {
                if(t.distractions) distractions.push(...t.distractions);
                if(t.completed && t.date_completed) {
                    try {
                        const h = parseInt(t.date_completed.split(' ')[1]?.split(':')[0]);
                        if(!isNaN(h)) completionHours[h] = (completionHours[h] || 0) + 1;
                    } catch(e) {}
                }
            });
            
            perfiles[u] = {
                datos_cuantitativos: {
                    nivel_y_xp: { xp_total: S.xp[u] || 0, mu_disponibles: S.coins[u] || 0 },
                    estadisticas_tareas: { total: userTasks.length, completadas: userTasks.filter(t=>t.completed).length, pendientes: userTasks.filter(t=>!t.completed).length, horas_pico_productividad: completionHours },
                    informacion_mara_egosombra: { total_distracciones: distractions.length }
                },
                datos_cualitativos: {
                    bitacora_personal: S.originalEgg?.perfiles_usuarios?.[u]?.datos_cualitativos?.bitacora_personal || [],
                    brainstorming_ideas: S.ideas.map(i => i.name),
                    tareas_detalladas: userTasks,
                    distracciones_detalladas: distractions
                }
            };
        });
        
        const eggData = {
            metadata: { version_huevo: "1.2 (WEB)", fecha_creacion: new Date().toISOString(), app_origen: "Killer Pendiente Web" },
            perfil_global: {
                lista_usuarios: users,
                estadisticas_globales: { total_usuarios: users.length, total_pv_acumulado: Object.values(S.xp).reduce((a,b)=>a+b,0) },
                comunicaciones_globales: S.originalEgg?.perfil_global?.comunicaciones_globales || {},
                gran_bitacora_universal: S.originalEgg?.perfil_global?.gran_bitacora_universal || []
            },
            perfiles_usuarios: perfiles
        };
        
        const content = `<<<COSMIC-EGG-START>>>\nFORMAT: COMPREHENSIVE-EGG-1.1\nCREATED: ${eggData.metadata.fecha_creacion}\n<<<DATA-START>>>\n${JSON.stringify(eggData, null, 2)}\n<<<DATA-END>>>\n<<<COSMIC-EGG-END>>>`;
        const blob = new Blob([content], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = `HuevoCosmico_${fmtDate(new Date()).replace(/-/g,'')}.cegg`;
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
        URL.revokeObjectURL(url);
        toast('¬°Exportado!', 'success');
    }
    
    function renderUsers() {
        const c = document.getElementById('userCards');
        const keys = Object.keys(S.users);
        if(!keys.length) { c.innerHTML='<div class="no-users">üåå Carga un Huevo o crea usuario</div>'; return; }
        c.innerHTML = keys.map(u => {
            const {lvl} = calcLevel(S.xp[u]||0);
            return `<div class="user-card" data-u="${u}" onclick="selectUser('${u}')"><div class="user-card-initial" style="background:${S.users[u].color}">${u[0].toUpperCase()}</div><div class="user-card-name">${esc(u)}</div><div class="user-card-xp">Nv${lvl}</div></div>`;
        }).join('');
    }
    
    function selectUser(u) {
        document.querySelectorAll('.user-card').forEach(c => c.classList.remove('selected'));
        const card = document.querySelector(`.user-card[data-u="${u}"]`);
        if(card) { card.classList.add('selected'); S.selCard=u; }
        document.getElementById('passGroup').style.display='block';
        document.getElementById('passInput').focus();
        document.getElementById('loginBtn').textContent = 'ENTRAR';
    }
    
    function login() {
        if(!S.selCard) { toast('Selecciona usuario', 'error'); return; }
        S.user = S.selCard;
        loadUserData();
        document.getElementById('headerAvatar').style.display='flex';
        document.getElementById('nav').style.display='flex';
        showScreen('main');
        toast(`¬°Hola, ${S.user}!`, 'success');
    }
    
    function logout() {
        S.user=null; S.selCard=null;
        document.getElementById('headerAvatar').style.display='none';
        document.getElementById('nav').style.display='none';
        document.getElementById('passGroup').style.display='none';
        document.getElementById('passInput').value='';
        document.getElementById('loginUser').value='';
        document.getElementById('loginPass').value='';
        document.querySelectorAll('.user-card').forEach(c=>c.classList.remove('selected'));
        showScreen('login');
    }
    
    function loadUserData() {
        const u=S.user, color=S.users[u]?.color||'#00ffff', xp=S.xp[u]||0, c=S.coins[u]||0;
        const {lvl,cur,next} = calcLevel(xp);
        const pct = Math.floor((cur/next)*100);
        
        const ha=document.getElementById('headerAvatar'); ha.textContent=u[0].toUpperCase(); ha.style.borderColor=color; ha.style.color=color;
        const sa=document.getElementById('sAvatar'); sa.textContent=u[0].toUpperCase(); sa.style.borderColor=color; sa.style.color=color;
        document.getElementById('sName').textContent=u; document.getElementById('sName').style.color=color;
        document.getElementById('sLevel').textContent=lvl;
        document.getElementById('curXp').textContent=cur; document.getElementById('nextXp').textContent=next;
        document.getElementById('xpPct').textContent=pct+'%'; document.getElementById('xpFill').style.width=pct+'%';
        document.getElementById('totalXp').textContent=xp; document.getElementById('coins').textContent=c;
        loadTasks();
    }
    
    function loadTasks() {
        const sortBy = document.getElementById('sortBy')?.value || 'priority';
        const filterPri = document.getElementById('filterPri')?.value || 'all';
        
        let tasks = S.tasks.filter(t => t.username===S.user && !t.completed);
        if(filterPri !== 'all') tasks = tasks.filter(t => t.priority === filterPri);
        
        if(sortBy === 'priority') tasks.sort((a,b) => ({A:0,B:1,C:2}[a.priority]||2)-({A:0,B:1,C:2}[b.priority]||2));
        else if(sortBy === 'date-asc') tasks.sort((a,b) => parseDate(a.date_added) - parseDate(b.date_added));
        else tasks.sort((a,b) => parseDate(b.date_added) - parseDate(a.date_added));
        
        document.getElementById('tCount').textContent=tasks.length;
        document.getElementById('pending').textContent=S.tasks.filter(t=>t.username===S.user&&!t.completed).length;
        renderTasks(tasks, 'tasksList', false);
    }
    
    function renderTasks(tasks, containerId, showOwner) {
        const c = document.getElementById(containerId);
        if(!tasks.length) { c.innerHTML='<div class="tasks-empty"><div class="tasks-empty-icon">üåå</div><div>No hay tareas</div></div>'; return; }
        c.innerHTML = tasks.map(t => {
            const age = getTimeAgo(t.date_added);
            return `<div class="task-card priority-${(t.priority||'c').toLowerCase()} ${t.completed?'completed':''}" data-id="${t.id}" oncontextmenu="showCtx(event,'${t.id}')" onclick="openEditModal('${t.id}')">
                <div class="task-actions"><button class="task-play" onclick="startTimer('${t.id}',event)">‚ñ∂</button><div class="task-check ${t.completed?'checked':''}" onclick="toggle('${t.id}',event)"></div></div>
                <div class="task-content"><div class="task-name">${esc(t.name)}</div><div class="task-meta"><span>‚è±${t.time||0}m</span><span>üìÅ${t.category||'Otro'}</span>${age?`<span class="task-age">üìÖ${age}</span>`:''}</div></div>
                <div class="task-xp">+${t.xp||0}</div>${showOwner?`<div class="task-owner" style="color:${S.users[t.username]?.color||'#888'}">${t.username}</div>`:''}
            </div>`;
        }).join('');
    }
    
    function addTask() {
        const name = document.getElementById('taskName').value.trim();
        if(!name) { toast('Escribe el desaf√≠o', 'error'); return; }
        S.tasks.push({ id: uuid(), name, xp: parseInt(document.getElementById('taskXp').value)||10, time: parseInt(document.getElementById('taskTime').value)||30, priority: document.getElementById('taskPri').value, category: document.getElementById('taskCat').value, completed: false, date_added: fmtDate(new Date()), username: S.user, distractions: [], delays: 0 });
        document.getElementById('taskName').value='';
        loadTasks(); save(); toast('¬°A√±adido!', 'success');
    }
    
    function toggle(id, e) {
        e.stopPropagation();
        const t = S.tasks.find(x=>x.id===id); if(!t) return;
        t.completed = !t.completed;
        if(t.completed) { t.date_completed=fmtDateTime(new Date()); S.xp[t.username]=(S.xp[t.username]||0)+(t.xp||0); toast(`+${t.xp||0} Pv!`, 'success'); }
        else { S.xp[t.username]=(S.xp[t.username]||0)-(t.xp||0); }
        if(S.user) loadUserData(); save();
    }
    
    function deleteTask(id) { const i = S.tasks.findIndex(x=>x.id===id); if(i>-1) { S.tasks.splice(i,1); loadTasks(); save(); toast('Eliminada', 'success'); } }
    
    // Timer
    function startTimer(taskId, e) {
        if(e) e.stopPropagation();
        const task = S.tasks.find(t => t.id === taskId);
        if(!task || !task.time) { toast('Sin duraci√≥n', 'error'); return; }
        Timer.active = true; Timer.taskId = taskId; Timer.totalSeconds = task.time * 60; Timer.remaining = Timer.totalSeconds;
        document.getElementById('timerTaskName').textContent = task.name;
        document.getElementById('timerPopup').classList.add('show');
        updateTimerDisplay();
        Timer.interval = setInterval(timerTick, 1000);
    }
    
    function timerTick() { if(Timer.remaining <= 0) { clearInterval(Timer.interval); timerComplete(); return; } Timer.remaining--; updateTimerDisplay(); }
    
    function updateTimerDisplay() {
        const m = Math.floor(Timer.remaining / 60), s = Timer.remaining % 60;
        const pct = (Timer.remaining / Timer.totalSeconds) * 100;
        const color = pct > 50 ? 'green' : pct > 20 ? 'orange' : 'red';
        document.getElementById('timerDisplay').textContent = `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
        document.getElementById('timerDisplay').className = 'timer-display ' + color;
        document.getElementById('timerProgress').style.width = pct + '%';
        document.getElementById('timerProgress').className = 'timer-progress-fill ' + color;
    }
    
    function timerComplete() { Timer.active = false; document.getElementById('timerPopup').classList.remove('show'); document.getElementById('extraTimeInput').classList.remove('show'); document.getElementById('completeActions').style.display = 'flex'; document.getElementById('completeModal').classList.add('show'); }
    function timerDone() { clearInterval(Timer.interval); timerComplete(); }
    function cancelTimer() { if(confirm('¬øCancelar?')) { clearInterval(Timer.interval); Timer.active = false; document.getElementById('timerPopup').classList.remove('show'); } }
    
    function confirmComplete(done) {
        if(done) {
            const t = S.tasks.find(x => x.id === Timer.taskId);
            if(t && !t.completed) { t.completed = true; t.date_completed = fmtDateTime(new Date()); S.xp[t.username] = (S.xp[t.username]||0) + (t.xp||0); loadUserData(); save(); toast(`¬°+${t.xp||0}Pv!`, 'success'); }
            closeCompleteModal();
        } else {
            const t = S.tasks.find(x => x.id === Timer.taskId);
            if(t) { t.delays = (t.delays||0)+1; save(); }
            document.getElementById('completeActions').style.display = 'none';
            document.getElementById('extraTimeInput').classList.add('show');
            document.getElementById('extraTimeValue').focus();
        }
    }
    
    function addExtraTime() {
        const extra = parseInt(document.getElementById('extraTimeValue').value) || 15;
        closeCompleteModal();
        Timer.totalSeconds = extra * 60; Timer.remaining = Timer.totalSeconds; Timer.active = true;
        document.getElementById('timerPopup').classList.add('show');
        updateTimerDisplay();
        Timer.interval = setInterval(timerTick, 1000);
        toast(`+${extra}min`, 'success');
    }
    
    function closeCompleteModal() { document.getElementById('completeModal').classList.remove('show'); }
    function logDistraction() { document.getElementById('distractionText').value = ''; document.getElementById('distractionModal').classList.add('show'); }
    function closeDistractionModal() { document.getElementById('distractionModal').classList.remove('show'); }
    function saveDistraction() {
        const text = document.getElementById('distractionText').value.trim();
        if(!text) return;
        const t = S.tasks.find(x => x.id === Timer.taskId);
        if(t) { if(!t.distractions) t.distractions = []; t.distractions.push({ text, timestamp: fmtDateTime(new Date()) }); save(); toast('Guardada', 'success'); }
        closeDistractionModal();
    }
    
    function showCtx(e, id) {
        e.preventDefault(); e.stopPropagation(); S.selTask=id;
        const m=document.getElementById('ctxMenu');
        m.style.left=Math.min(e.pageX, window.innerWidth-160)+'px';
        m.style.top=Math.min(e.pageY, window.innerHeight-180)+'px';
        m.classList.add('show');
        setTimeout(()=>{document.addEventListener('click',closeCtx);document.addEventListener('touchstart',closeCtx);},10);
    }
    function closeCtx() { document.getElementById('ctxMenu').classList.remove('show'); document.removeEventListener('click',closeCtx); document.removeEventListener('touchstart',closeCtx); }
    function ctxPlay() { if(S.selTask) startTimer(S.selTask); closeCtx(); }
    function ctxComplete() { if(S.selTask) toggle(S.selTask,{stopPropagation:()=>{}}); closeCtx(); }
    function ctxEdit() { if(S.selTask) openEditModal(S.selTask); closeCtx(); }
    function ctxDelete() { if(S.selTask && confirm('¬øEliminar?')) deleteTask(S.selTask); closeCtx(); }
    
    function openEditModal(id) {
        const t=S.tasks.find(x=>x.id===id); if(!t) return; S.selTask=id;
        document.getElementById('eName').value=t.name||'';
        document.getElementById('eXp').value=t.xp||10;
        document.getElementById('eTime').value=t.time||30;
        document.getElementById('ePri').value=t.priority||'C';
        document.getElementById('eCat').value=t.category||'Otro';
        document.getElementById('editModal').classList.add('show');
    }
    function closeEditModal() { document.getElementById('editModal').classList.remove('show'); S.selTask=null; }
    function saveEdit() {
        const t=S.tasks.find(x=>x.id===S.selTask); if(!t) return;
        t.name=document.getElementById('eName').value.trim()||t.name;
        t.xp=parseInt(document.getElementById('eXp').value)||t.xp;
        t.time=parseInt(document.getElementById('eTime').value)||t.time;
        t.priority=document.getElementById('ePri').value;
        t.category=document.getElementById('eCat').value;
        loadTasks(); save(); closeEditModal(); toast('Guardado', 'success');
    }
    
    function updateFilters() {
        const s=document.getElementById('fUser'); s.innerHTML='<option value="all">Todos</option>';
        Object.keys(S.users).forEach(u => { const o=document.createElement('option'); o.value=u; o.textContent=u; s.appendChild(o); });
    }
    function filterUniverse() {
        const fu=document.getElementById('fUser').value, fp=document.getElementById('fPri').value, fs=document.getElementById('fSort').value;
        let tasks = S.tasks.filter(t=>!t.completed);
        if(fu!=='all') tasks=tasks.filter(t=>t.username===fu);
        if(fp!=='all') tasks=tasks.filter(t=>t.priority===fp);
        if(fs === 'priority') tasks.sort((a,b)=>({A:0,B:1,C:2}[a.priority]||2)-({A:0,B:1,C:2}[b.priority]||2));
        else if(fs === 'date-asc') tasks.sort((a,b) => parseDate(a.date_added) - parseDate(b.date_added));
        else tasks.sort((a,b) => parseDate(b.date_added) - parseDate(a.date_added));
        document.getElementById('uniTotal').textContent=tasks.length;
        document.getElementById('uniXp').textContent=tasks.reduce((s,t)=>s+(t.xp||0),0);
        renderTasks(tasks, 'uniList', true);
    }
    
    function loadIdeas() {
        document.getElementById('iCount').textContent=S.ideas.length;
        const c=document.getElementById('ideasList');
        if(!S.ideas.length) { c.innerHTML='<div class="tasks-empty"><div class="tasks-empty-icon">üí≠</div><div>No hay ideas</div></div>'; return; }
        c.innerHTML = S.ideas.map(i => `<div class="idea-card"><div class="idea-text">${esc(i.name)}</div><div class="idea-actions"><button class="idea-btn" onclick="transferIdea('${i.id}')">üìã</button><button class="idea-btn" onclick="deleteIdea('${i.id}')">üóëÔ∏è</button></div></div>`).join('');
    }
    function addIdea() {
        const t=document.getElementById('ideaInput').value.trim();
        if(!t) return;
        S.ideas.push({id:uuid(),name:t});
        document.getElementById('ideaInput').value='';
        loadIdeas(); save(); toast('Guardada', 'success');
    }
    function deleteIdea(id) { const i=S.ideas.findIndex(x=>x.id===id); if(i>-1) { S.ideas.splice(i,1); loadIdeas(); save(); } }
    function transferIdea(id) {
        if(!S.user) { toast('Inicia sesi√≥n', 'error'); return; }
        const idea=S.ideas.find(x=>x.id===id); if(!idea) return;
        S.tasks.push({id:uuid(),name:idea.name,xp:10,time:30,priority:'C',category:'Otro',completed:false,date_added:fmtDate(new Date()),username:S.user,distractions:[],delays:0});
        const i=S.ideas.findIndex(x=>x.id===id); if(i>-1) S.ideas.splice(i,1);
        loadIdeas(); save(); toast('Convertida', 'success');
    }
    
    function showScreen(name) {
        document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
        document.getElementById(name+'Screen')?.classList.add('active');
        document.querySelectorAll('.nav-item').forEach(n=>{n.classList.remove('active');if(n.dataset.s===name)n.classList.add('active');});
        if(name==='universe') filterUniverse();
        if(name==='brainstorm') loadIdeas();
    }
    
    function save() { localStorage.setItem('kp', JSON.stringify({users:S.users,tasks:S.tasks,xp:S.xp,coins:S.coins,ideas:S.ideas,loaded:S.loaded,originalEgg:S.originalEgg,localUsers:S.localUsers})); }
    function load() {
        const d=localStorage.getItem('kp'); if(!d) return;
        try { 
            const p=JSON.parse(d); 
            S.users=p.users||{}; S.tasks=p.tasks||[]; S.xp=p.xp||{}; S.coins=p.coins||{}; S.ideas=p.ideas||[]; S.loaded=p.loaded||false; S.originalEgg=p.originalEgg||null; S.localUsers=p.localUsers||{};
            if(S.loaded || Object.keys(S.users).length) { 
                if(S.loaded) {
                    document.getElementById('loadEggBtn').style.display = 'none';
                    document.getElementById('eggLoadedBar').style.display = 'flex';
                    document.getElementById('eggUserCount').textContent = Object.keys(S.users).length;
                    document.getElementById('loginBtn').textContent = 'ENTRAR';
                }
                document.getElementById('btnExport').style.display = 'flex';
                renderUsers(); 
                updateFilters(); 
            }
        } catch(e) {}
    }
    
    ['editModal','distractionModal','completeModal'].forEach(id => {
        document.getElementById(id).addEventListener('click', e => { if(e.target.id===id) { if(id==='editModal') closeEditModal(); else if(id==='distractionModal') closeDistractionModal(); else closeCompleteModal(); } });
    });
    
    document.addEventListener('DOMContentLoaded', () => {
        load();
        document.getElementById('passInput').addEventListener('keypress', e => { if(e.key==='Enter') handleLogin(); });
        document.getElementById('taskName').addEventListener('keypress', e => { if(e.key==='Enter') addTask(); });
        document.getElementById('ideaInput').addEventListener('keypress', e => { if(e.key==='Enter') addIdea(); });
        document.getElementById('extraTimeValue').addEventListener('keypress', e => { if(e.key==='Enter') addExtraTime(); });
        document.getElementById('loginUser').addEventListener('keypress', e => { if(e.key==='Enter') document.getElementById('loginPass').focus(); });
        document.getElementById('loginPass').addEventListener('keypress', e => { if(e.key==='Enter') handleLogin(); });
        document.addEventListener('keydown', e => { if(e.key==='Escape') { closeCtx(); closeEditModal(); closeDistractionModal(); closeCompleteModal(); } });
    });
    </script>
</body>
</html>
